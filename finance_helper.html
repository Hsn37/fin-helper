<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Helper</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ========== CONFIGURATION ==========
        // Edit these URLs to point to your n8n workflows
        const PROCESS_WORKFLOW_URL = 'https://axonbuild.app.n8n.cloud/webhook/process-logs';
        const SAVE_WORKFLOW_URL = 'https://your-n8n-instance.com/webhook/save';
        // ===================================

        const { useState, useEffect } = React;

        const CATEGORIES = [
            'Transportation',
            'Food',
            'Personal Expenses',
            'Entertainment',
            'Household Stuff',
            'Extras'
        ];

        function FinancialHelper() {
            const [logs, setLogs] = useState('');
            const [itemizedData, setItemizedData] = useState([]);
            const [categoryTotals, setCategoryTotals] = useState({});
            const [notes, setNotes] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [error, setError] = useState('');

            // Parse CSV string into array of objects
            const parseCSV = (csvString) => {
                if (!csvString || !csvString.trim()) return [];
                
                const lines = csvString.trim().split('\n');
                if (lines.length < 2) return [];
                
                // Parse header
                const headers = lines[0].split(',').map(h => h.trim());
                
                // Parse data rows
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    const row = {};
                    headers.forEach((header, idx) => {
                        row[header] = values[idx] || '';
                    });
                    data.push(row);
                }
                
                return data;
            };

            // Parse category totals CSV
            const parseCategoryTotals = (csvString) => {
                if (!csvString || !csvString.trim()) return {};
                
                const lines = csvString.trim().split('\n');
                const totals = {};
                
                // Skip header if present, process data rows
                const startIdx = lines[0].toLowerCase().includes('category') ? 1 : 0;
                
                for (let i = startIdx; i < lines.length; i++) {
                    const parts = lines[i].split(',').map(p => p.trim());
                    if (parts.length >= 2) {
                        const category = parts[0];
                        const amount = parseFloat(parts[1]) || 0;
                        if (category) {
                            totals[category] = amount;
                        }
                    }
                }
                
                return totals;
            };

            // Calculate totals from itemized data
            const calculateTotals = (items) => {
                const totals = {};
                CATEGORIES.forEach(cat => {
                    totals[cat] = 0;
                });
                
                items.forEach(item => {
                    const category = item.category || item.Category || '';
                    const amount = parseFloat(item.amount || item.Amount || item['Amount'] || 0) || 0;
                    if (category && totals.hasOwnProperty(category)) {
                        totals[category] = (totals[category] || 0) + amount;
                    }
                });
                
                return totals;
            };

            const handleProcess = async () => {
                if (!logs.trim()) {
                    setError('Please enter some financial logs');
                    return;
                }

                setIsProcessing(true);
                setError('');

                try {
                    const response = await fetch(PROCESS_WORKFLOW_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ logs: logs })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // Parse the CSV data
                    const parsedItemized = parseCSV(data.itemized_csv || '');
                    const parsedTotals = parseCategoryTotals(data.category_totals_csv || '');
                    
                    // Initialize itemized data with categories
                    const itemizedWithCategories = parsedItemized.map(item => {
                        // Try to find existing category from various possible column names
                        const existingCategory = item.category || item.Category || item.CATEGORY || '';
                        // If category exists and is valid, use it; otherwise default to first category
                        const category = CATEGORIES.includes(existingCategory) 
                            ? existingCategory 
                            : (CATEGORIES.includes(existingCategory) ? existingCategory : CATEGORIES[0]);
                        
                        return {
                            ...item,
                            category: category
                        };
                    });
                    
                    setItemizedData(itemizedWithCategories);
                    setCategoryTotals(parsedTotals);
                    setNotes(data.notes || []);
                } catch (err) {
                    setError(`Error processing logs: ${err.message}`);
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleCategoryChange = (index, newCategory) => {
                const updated = [...itemizedData];
                updated[index].category = newCategory;
                setItemizedData(updated);
                
                // Recalculate totals
                const newTotals = calculateTotals(updated);
                setCategoryTotals(newTotals);
            };

            const handleSave = async () => {
                if (!itemizedData.length) return;

                setIsSaving(true);
                setError('');

                try {
                    // Calculate final totals
                    const finalTotals = calculateTotals(itemizedData);
                    
                    // Prepare payload according to API spec
                    const payload = {
                        totals: finalTotals,
                        notes: notes
                    };

                    const response = await fetch(SAVE_WORKFLOW_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    alert('Data saved successfully!');
                    setLogs('');
                    setItemizedData([]);
                    setCategoryTotals({});
                    setNotes([]);
                } catch (err) {
                    setError(`Error saving data: ${err.message}`);
                } finally {
                    setIsSaving(false);
                }
            };

            // Get table headers from first item
            const getHeaders = () => {
                if (itemizedData.length === 0) return [];
                const firstItem = itemizedData[0];
                // Exclude 'category' from headers as it will be in a separate column
                return Object.keys(firstItem).filter(key => key.toLowerCase() !== 'category');
            };

            const headers = getHeaders();

            return (
                <div className="min-h-screen bg-yellow-300 p-6" style={{ fontFamily: 'system-ui, -apple-system, sans-serif' }}>
                    <div className="max-w-7xl mx-auto">
                        {/* Header Card */}
                        <div className="bg-white border-4 border-black p-8 mb-6" style={{ boxShadow: '8px 8px 0px 0px #000' }}>
                            <h1 className="text-5xl font-black text-black mb-2" style={{ letterSpacing: '-0.02em' }}>
                                Financial Helper
                            </h1>
                            <p className="text-black text-base mb-6 font-bold">Organize and categorize your expenses effortlessly</p>

                            <div className="mb-6">
                                <label className="block text-base font-black text-black mb-3 uppercase">
                                    Paste your financial logs here:
                                </label>
                                <textarea
                                    value={logs}
                                    onChange={(e) => setLogs(e.target.value)}
                                    placeholder="Jan 5&#10;2150 amazon, headphones&#10;740 grocery store, bread&#10;1200 metro, commuting&#10;..."
                                    className="w-full h-64 px-5 py-4 bg-white border-4 border-black font-mono text-sm resize-y font-bold"
                                    style={{ boxShadow: '4px 4px 0px 0px #000', outline: 'none' }}
                                />
                            </div>

                            {error && (
                                <div className="mb-6 p-4 bg-red-500 border-4 border-black text-white font-black" style={{ boxShadow: '4px 4px 0px 0px #000' }}>
                                    <span className="font-black">‚ö†Ô∏è</span> {error}
                                </div>
                            )}

                            <button
                                onClick={handleProcess}
                                disabled={isProcessing || !logs.trim()}
                                className={`w-full py-5 text-white border-4 border-black font-black text-xl uppercase ${(isProcessing || !logs.trim()) ? 'bg-gray-400' : 'bg-blue-500'}`}
                                style={{ 
                                    boxShadow: '6px 6px 0px 0px #000',
                                    transition: 'all 0.1s',
                                    cursor: (isProcessing || !logs.trim()) ? 'not-allowed' : 'pointer'
                                }}
                                onMouseDown={(e) => {
                                    if (!isProcessing && logs.trim()) {
                                        e.currentTarget.style.transform = 'translate(3px, 3px)';
                                        e.currentTarget.style.boxShadow = '3px 3px 0px 0px #000';
                                    }
                                }}
                                onMouseUp={(e) => {
                                    if (!isProcessing && logs.trim()) {
                                        e.currentTarget.style.transform = 'translate(0px, 0px)';
                                        e.currentTarget.style.boxShadow = '6px 6px 0px 0px #000';
                                    }
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.transform = 'translate(0px, 0px)';
                                    e.currentTarget.style.boxShadow = '6px 6px 0px 0px #000';
                                }}
                            >
                                {isProcessing ? (
                                    <span className="flex items-center justify-center">
                                        <span className="inline-block animate-bounce mr-2" style={{ animationDelay: '0ms' }}>‚ö°</span>
                                        <span className="inline-block animate-bounce mr-2" style={{ animationDelay: '150ms' }}>üí´</span>
                                        <span className="inline-block animate-bounce mr-2" style={{ animationDelay: '300ms' }}>‚ú®</span>
                                        <span className="ml-2">Processing</span>
                                        <span className="inline-block animate-pulse ml-1" style={{ animationDelay: '0ms' }}>.</span>
                                        <span className="inline-block animate-pulse ml-0" style={{ animationDelay: '200ms' }}>.</span>
                                        <span className="inline-block animate-pulse ml-0" style={{ animationDelay: '400ms' }}>.</span>
                                    </span>
                                ) : (
                                    '‚ú® Process Logs'
                                )}
                            </button>
                        </div>

                        {itemizedData.length > 0 && (
                            <div className="space-y-6">
                                {/* Itemized Table */}
                                <div className="bg-white border-4 border-black p-8" style={{ boxShadow: '8px 8px 0px 0px #000' }}>
                                    <h2 className="text-4xl font-black text-black mb-6 flex items-center uppercase" style={{ letterSpacing: '-0.02em' }}>
                                        <span className="mr-3">üìã</span> Itemized Expenses
                                    </h2>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full border-collapse" style={{ border: '4px solid #000' }}>
                                            <thead>
                                                <tr className="bg-green-500">
                                                    {headers.map((header, idx) => (
                                                        <th key={idx} className="px-6 py-4 text-left font-black text-white text-sm uppercase tracking-wider border-2 border-black">
                                                            {header}
                                                        </th>
                                                    ))}
                                                    <th className="px-6 py-4 text-left font-black text-white text-sm uppercase tracking-wider border-2 border-black">
                                                        Category
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white">
                                                {itemizedData.map((item, rowIdx) => (
                                                    <tr key={rowIdx} className={rowIdx % 2 === 0 ? 'bg-white' : 'bg-yellow-100'}>
                                                        {headers.map((header, cellIdx) => (
                                                            <td key={cellIdx} className="px-6 py-4 text-black font-bold border-2 border-black">
                                                                {item[header]}
                                                            </td>
                                                        ))}
                                                        <td className="px-6 py-4 border-2 border-black">
                                                            <select
                                                                value={item.category || CATEGORIES[0]}
                                                                onChange={(e) => handleCategoryChange(rowIdx, e.target.value)}
                                                                className="w-full px-4 py-2 bg-white border-4 border-black font-black text-black uppercase"
                                                                style={{ boxShadow: '2px 2px 0px 0px #000', outline: 'none' }}
                                                            >
                                                                {CATEGORIES.map(cat => (
                                                                    <option key={cat} value={cat}>{cat}</option>
                                                                ))}
                                                            </select>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* Category Totals Table */}
                                <div className="bg-white border-4 border-black p-8" style={{ boxShadow: '8px 8px 0px 0px #000' }}>
                                    <h2 className="text-4xl font-black text-black mb-6 flex items-center uppercase" style={{ letterSpacing: '-0.02em' }}>
                                        <span className="mr-3">üí∞</span> Category Totals
                                    </h2>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full border-collapse" style={{ border: '4px solid #000' }}>
                                            <thead>
                                                <tr className="bg-red-500">
                                                    <th className="px-6 py-4 text-left font-black text-white text-sm uppercase tracking-wider border-2 border-black">
                                                        Category
                                                    </th>
                                                    <th className="px-6 py-4 text-left font-black text-white text-sm uppercase tracking-wider border-2 border-black">
                                                        Total
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white">
                                                {CATEGORIES.map((category, idx) => {
                                                    const total = categoryTotals[category] || 0;
                                                    return (
                                                        <tr key={category} className={idx % 2 === 0 ? 'bg-white' : 'bg-yellow-100'}>
                                                            <td className="px-6 py-4 font-black text-black border-2 border-black uppercase">
                                                                {category}
                                                            </td>
                                                            <td className="px-6 py-4 text-black font-black border-2 border-black">
                                                                <span className="text-xl">{total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                                <tr className="bg-black font-black">
                                                    <td className="px-6 py-5 text-white text-xl border-2 border-black uppercase">
                                                        Grand Total
                                                    </td>
                                                    <td className="px-6 py-5 text-white text-2xl border-2 border-black">
                                                        {Object.values(categoryTotals).reduce((sum, val) => sum + (val || 0), 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* Notes */}
                                {notes.length > 0 && (
                                    <div className="bg-white border-4 border-black p-8" style={{ boxShadow: '8px 8px 0px 0px #000' }}>
                                        <h2 className="text-4xl font-black text-black mb-6 flex items-center uppercase" style={{ letterSpacing: '-0.02em' }}>
                                            <span className="mr-3">üí°</span> Notes
                                        </h2>
                                        <div className="bg-blue-500 border-4 border-black p-6" style={{ boxShadow: '4px 4px 0px 0px #000' }}>
                                            <ul className="space-y-3">
                                                {notes.map((note, idx) => (
                                                    <li key={idx} className="flex items-start text-white">
                                                        <span className="text-black mr-3 text-xl font-black">‚Üí</span>
                                                        <span className="text-white font-black leading-relaxed">{note}</span>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    </div>
                                )}

                                {/* Save Button */}
                                <div className="bg-white border-4 border-black p-8" style={{ boxShadow: '8px 8px 0px 0px #000' }}>
                                    <button
                                        onClick={handleSave}
                                        disabled={isSaving}
                                        className={`w-full py-5 text-white border-4 border-black font-black text-xl uppercase ${isSaving ? 'bg-gray-400' : 'bg-green-500'}`}
                                        style={{ 
                                            boxShadow: '6px 6px 0px 0px #000',
                                            transition: 'all 0.1s',
                                            cursor: isSaving ? 'not-allowed' : 'pointer'
                                        }}
                                        onMouseDown={(e) => {
                                            if (!isSaving) {
                                                e.currentTarget.style.transform = 'translate(3px, 3px)';
                                                e.currentTarget.style.boxShadow = '3px 3px 0px 0px #000';
                                            }
                                        }}
                                        onMouseUp={(e) => {
                                            if (!isSaving) {
                                                e.currentTarget.style.transform = 'translate(0px, 0px)';
                                                e.currentTarget.style.boxShadow = '6px 6px 0px 0px #000';
                                            }
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.transform = 'translate(0px, 0px)';
                                            e.currentTarget.style.boxShadow = '6px 6px 0px 0px #000';
                                        }}
                                    >
                                        {isSaving ? (
                                            <span className="flex items-center justify-center">
                                                <span className="animate-spin mr-2">üíæ</span> Saving...
                                            </span>
                                        ) : (
                                            '‚úÖ Save & Approve'
                                        )}
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<FinancialHelper />, document.getElementById('root'));
    </script>
</body>
</html>