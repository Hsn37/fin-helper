<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Helper</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ========== CONFIGURATION ==========
        // Edit these URLs to point to your n8n workflows
        const PROCESS_WORKFLOW_URL = 'https://axonbuild.app.n8n.cloud/webhook/process-logs';
        // ===================================

        const { useState, useEffect } = React;

        const CATEGORIES = [
            'Transportation',
            'Food',
            'Personal Expenses',
            'Entertainment',
            'Household Stuff',
            'Extras'
        ];

        function FinancialHelper() {
            const [logs, setLogs] = useState('');
            const [itemizedData, setItemizedData] = useState([]);
            const [categoryTotals, setCategoryTotals] = useState({});
            const [notes, setNotes] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [error, setError] = useState('');

            // Parse CSV string into array of objects
            const parseCSV = (csvString) => {
                if (!csvString || !csvString.trim()) return [];
                
                const lines = csvString.trim().split('\n');
                if (lines.length < 2) return [];
                
                // Parse header
                const headers = lines[0].split(',').map(h => h.trim());
                
                // Parse data rows
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    const row = {};
                    headers.forEach((header, idx) => {
                        row[header] = values[idx] || '';
                    });
                    data.push(row);
                }
                
                return data;
            };

            // Calculate totals from itemized data
            const calculateTotals = (items) => {
                const totals = {};
                CATEGORIES.forEach(cat => {
                    totals[cat] = 0;
                });
                
                items.forEach(item => {
                    const category = item.category || item.Category || '';
                    const amount = parseFloat(item.amount || item.Amount || item['Amount'] || 0) || 0;
                    if (category && totals.hasOwnProperty(category)) {
                        totals[category] = (totals[category] || 0) + amount;
                    }
                });
                
                return totals;
            };

            const handleProcess = async () => {
                if (!logs.trim()) {
                    setError('Please enter some financial logs');
                    return;
                }

                setIsProcessing(true);
                setError('');

                try {
                    const response = await fetch(PROCESS_WORKFLOW_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ logs: logs })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // Parse the CSV data
                    const parsedItemized = parseCSV(data.itemized_csv || '');
                    
                    // Initialize itemized data with categories
                    const itemizedWithCategories = parsedItemized.map(item => {
                        // Try to find existing category from various possible column names
                        const existingCategory = item.category || item.Category || item.CATEGORY || '';
                        // If category exists and is valid, use it; otherwise default to first category
                        const category = CATEGORIES.includes(existingCategory) 
                            ? existingCategory 
                            : (CATEGORIES.includes(existingCategory) ? existingCategory : CATEGORIES[0]);
                        
                        return {
                            ...item,
                            category: category
                        };
                    });
                    
                    // Compute totals from the itemized data
                    const computedTotals = calculateTotals(itemizedWithCategories);
                    
                    setItemizedData(itemizedWithCategories);
                    setCategoryTotals(computedTotals);
                    setNotes(data.notes || []);
                } catch (err) {
                    setError(`Error processing logs: ${err.message}`);
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleCategoryChange = (index, newCategory) => {
                const updated = [...itemizedData];
                updated[index].category = newCategory;
                setItemizedData(updated);
                
                // Recalculate totals
                const newTotals = calculateTotals(updated);
                setCategoryTotals(newTotals);
            };

            // Fallback copy function for non-secure contexts
            const fallbackCopyToClipboard = (text) => {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    return successful;
                } catch (err) {
                    document.body.removeChild(textArea);
                    return false;
                }
            };

            const copyCategoryTotals = async () => {
                // Format as tab-separated values horizontally for Excel
                const categories = CATEGORIES.join('\t');
                const totals = CATEGORIES.map(category => {
                    const total = categoryTotals[category] || 0;
                    return total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }).join('\t');
                
                const text = `${totals}`;
                
                // Try modern clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    try {
                        await navigator.clipboard.writeText(text);
                        alert('Category totals copied to clipboard! Paste into Excel.');
                        return;
                    } catch (err) {
                        console.error('Clipboard API failed:', err);
                    }
                }
                
                // Fallback to execCommand
                if (fallbackCopyToClipboard(text)) {
                    alert('Category totals copied to clipboard! Paste into Excel.');
                } else {
                    setError('Failed to copy to clipboard. Please copy manually.');
                }
            };

            const copyNotes = async () => {
                // Format notes as bullet points
                const text = notes.map(note => `• ${note}`).join('\n');
                
                // Try modern clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    try {
                        await navigator.clipboard.writeText(text);
                        alert('Notes copied to clipboard!');
                        return;
                    } catch (err) {
                        console.error('Clipboard API failed:', err);
                    }
                }
                
                // Fallback to execCommand
                if (fallbackCopyToClipboard(text)) {
                    alert('Notes copied to clipboard!');
                } else {
                    setError('Failed to copy to clipboard. Please copy manually.');
                }
            };

            // Get table headers from first item
            const getHeaders = () => {
                if (itemizedData.length === 0) return [];
                const firstItem = itemizedData[0];
                // Exclude 'category' from headers as it will be in a separate column
                return Object.keys(firstItem).filter(key => key.toLowerCase() !== 'category');
            };

            const headers = getHeaders();

            return (
                <div className="min-h-screen bg-orange-50 p-3 sm:p-4 md:p-6" style={{ fontFamily: 'system-ui, -apple-system, sans-serif' }}>
                    <div className="max-w-7xl mx-auto">
                        {/* Header Card */}
                        <div className="bg-white border-2 sm:border-4 border-black p-4 sm:p-6 md:p-8 mb-4 sm:mb-6" style={{ boxShadow: '8px 8px 0px 0px #000' }}>
                            <h1 className="text-3xl sm:text-4xl md:text-5xl font-black text-black mb-2" style={{ letterSpacing: '-0.02em' }}>
                                Financial Helper
                            </h1>
                            <p className="text-black text-sm sm:text-base mb-4 sm:mb-6 font-bold">Organize and categorize your expenses effortlessly</p>

                            <div className="mb-4 sm:mb-6">
                                <label className="block text-sm sm:text-base font-black text-black mb-2 sm:mb-3 uppercase">
                                    Paste your financial logs here:
                                </label>
                                <textarea
                                    value={logs}
                                    onChange={(e) => setLogs(e.target.value)}
                                    placeholder="Jan 5&#10;2150 amazon, headphones&#10;740 grocery store, bread&#10;1200 metro, commuting&#10;..."
                                    className="w-full h-48 sm:h-56 md:h-64 px-3 sm:px-4 md:px-5 py-3 sm:py-4 bg-white border-2 sm:border-4 border-black font-mono text-xs sm:text-sm resize-y font-bold text-black"
                                    style={{ boxShadow: '4px 4px 0px 0px #000', outline: 'none' }}
                                />
                            </div>

                            {error && (
                                <div className="mb-4 sm:mb-6 p-3 sm:p-4 bg-red-500 border-2 sm:border-4 border-black text-white font-black text-sm sm:text-base" style={{ boxShadow: '4px 4px 0px 0px #000' }}>
                                    {error}
                                </div>
                            )}

                            <button
                                onClick={handleProcess}
                                disabled={isProcessing || !logs.trim()}
                                className={`w-full py-3 sm:py-4 md:py-5 text-white border-2 sm:border-4 border-black font-black text-base sm:text-lg md:text-xl uppercase ${(isProcessing || !logs.trim()) ? 'bg-gray-400' : 'bg-orange-500'}`}
                                style={{ 
                                    boxShadow: '6px 6px 0px 0px #000',
                                    transition: 'all 0.1s',
                                    cursor: (isProcessing || !logs.trim()) ? 'not-allowed' : 'pointer'
                                }}
                                onMouseDown={(e) => {
                                    if (!isProcessing && logs.trim()) {
                                        e.currentTarget.style.transform = 'translate(3px, 3px)';
                                        e.currentTarget.style.boxShadow = '3px 3px 0px 0px #000';
                                    }
                                }}
                                onMouseUp={(e) => {
                                    if (!isProcessing && logs.trim()) {
                                        e.currentTarget.style.transform = 'translate(0px, 0px)';
                                        e.currentTarget.style.boxShadow = '6px 6px 0px 0px #000';
                                    }
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.transform = 'translate(0px, 0px)';
                                    e.currentTarget.style.boxShadow = '6px 6px 0px 0px #000';
                                }}
                            >
                                {isProcessing ? (
                                    <span className="flex items-center justify-center">
                                        <span className="animate-spin mr-2">⟳</span>
                                        Processing
                                        <span className="inline-block animate-pulse ml-1" style={{ animationDelay: '0ms' }}>.</span>
                                        <span className="inline-block animate-pulse ml-0" style={{ animationDelay: '200ms' }}>.</span>
                                        <span className="inline-block animate-pulse ml-0" style={{ animationDelay: '400ms' }}>.</span>
                                    </span>
                                ) : (
                                    'Process Logs'
                                )}
                            </button>
                        </div>

                        {itemizedData.length > 0 && (
                            <div className="space-y-4 sm:space-y-6">
                                {/* Itemized Table */}
                                <div className="bg-white border-2 sm:border-4 border-black p-4 sm:p-6 md:p-8" style={{ boxShadow: '8px 8px 0px 0px #000' }}>
                                    <h2 className="text-2xl sm:text-3xl md:text-4xl font-black text-black mb-4 sm:mb-6 uppercase" style={{ letterSpacing: '-0.02em' }}>
                                        Itemized Expenses
                                    </h2>
                                    <div className="overflow-x-auto -mx-4 sm:mx-0 px-4 sm:px-0">
                                        <div className="inline-block min-w-full align-middle">
                                            <table className="min-w-full border-collapse" style={{ border: '4px solid #000' }}>
                                                <thead>
                                                    <tr className="bg-orange-500">
                                                        {headers.map((header, idx) => (
                                                            <th key={idx} className="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 text-left font-black text-white text-xs sm:text-sm uppercase tracking-wider border-2 border-black whitespace-nowrap">
                                                                {header}
                                                            </th>
                                                        ))}
                                                        <th className="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 text-left font-black text-white text-xs sm:text-sm uppercase tracking-wider border-2 border-black">
                                                            Category
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody className="bg-white">
                                                    {itemizedData.map((item, rowIdx) => (
                                                        <tr key={rowIdx} className={rowIdx % 2 === 0 ? 'bg-white' : 'bg-orange-50'}>
                                                            {headers.map((header, cellIdx) => (
                                                                <td key={cellIdx} className="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 text-black font-bold border-2 border-black text-xs sm:text-sm">
                                                                    {item[header]}
                                                                </td>
                                                            ))}
                                                            <td className="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 border-2 border-black">
                                                                <select
                                                                    value={item.category || CATEGORIES[0]}
                                                                    onChange={(e) => handleCategoryChange(rowIdx, e.target.value)}
                                                                    className="w-full px-2 sm:px-3 md:px-4 py-1.5 sm:py-2 bg-white border-2 sm:border-4 border-black font-black text-black uppercase text-xs sm:text-sm"
                                                                    style={{ boxShadow: '2px 2px 0px 0px #000', outline: 'none' }}
                                                                >
                                                                    {CATEGORIES.map(cat => (
                                                                        <option key={cat} value={cat}>{cat}</option>
                                                                    ))}
                                                                </select>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                {/* Category Totals Table */}
                                <div className="bg-white border-2 sm:border-4 border-black p-4 sm:p-6 md:p-8" style={{ boxShadow: '8px 8px 0px 0px #000' }}>
                                    <div className="flex items-center justify-between mb-4 sm:mb-6">
                                        <h2 className="text-2xl sm:text-3xl md:text-4xl font-black text-black uppercase" style={{ letterSpacing: '-0.02em' }}>
                                            Category Totals
                                        </h2>
                                        <button
                                            onClick={copyCategoryTotals}
                                            className="px-3 sm:px-4 md:px-5 py-2 sm:py-2.5 md:py-3 bg-green-500 text-white border-2 sm:border-4 border-black font-black text-xs sm:text-sm md:text-base uppercase"
                                            style={{ 
                                                boxShadow: '4px 4px 0px 0px #000',
                                                transition: 'all 0.1s',
                                                cursor: 'pointer'
                                            }}
                                            onMouseDown={(e) => {
                                                e.currentTarget.style.transform = 'translate(2px, 2px)';
                                                e.currentTarget.style.boxShadow = '2px 2px 0px 0px #000';
                                            }}
                                            onMouseUp={(e) => {
                                                e.currentTarget.style.transform = 'translate(0px, 0px)';
                                                e.currentTarget.style.boxShadow = '4px 4px 0px 0px #000';
                                            }}
                                            onMouseLeave={(e) => {
                                                e.currentTarget.style.transform = 'translate(0px, 0px)';
                                                e.currentTarget.style.boxShadow = '4px 4px 0px 0px #000';
                                            }}
                                        >
                                            Copy
                                        </button>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full border-collapse" style={{ border: '4px solid #000' }}>
                                            <thead>
                                                <tr className="bg-amber-500">
                                                    <th className="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 text-left font-black text-white text-xs sm:text-sm uppercase tracking-wider border-2 border-black">
                                                        Category
                                                    </th>
                                                    <th className="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 text-left font-black text-white text-xs sm:text-sm uppercase tracking-wider border-2 border-black">
                                                        Total
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white">
                                                {CATEGORIES.map((category, idx) => {
                                                    const total = categoryTotals[category] || 0;
                                                    return (
                                                        <tr key={category} className={idx % 2 === 0 ? 'bg-white' : 'bg-orange-50'}>
                                                            <td className="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 font-black text-black border-2 border-black uppercase text-xs sm:text-sm">
                                                                {category}
                                                            </td>
                                                            <td className="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 text-black font-black border-2 border-black">
                                                                <span className="text-base sm:text-lg md:text-xl">{total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                                <tr className="bg-black font-black">
                                                    <td className="px-3 sm:px-4 md:px-6 py-3 sm:py-4 md:py-5 text-white text-base sm:text-lg md:text-xl border-2 border-black uppercase">
                                                        Grand Total
                                                    </td>
                                                    <td className="px-3 sm:px-4 md:px-6 py-3 sm:py-4 md:py-5 text-white text-lg sm:text-xl md:text-2xl border-2 border-black">
                                                        {Object.values(categoryTotals).reduce((sum, val) => sum + (val || 0), 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* Notes */}
                                {notes.length > 0 && (
                                    <div className="bg-white border-2 sm:border-4 border-black p-4 sm:p-6 md:p-8" style={{ boxShadow: '8px 8px 0px 0px #000' }}>
                                        <div className="flex items-center justify-between mb-4 sm:mb-6">
                                            <h2 className="text-2xl sm:text-3xl md:text-4xl font-black text-black uppercase" style={{ letterSpacing: '-0.02em' }}>
                                                Notes
                                            </h2>
                                            <button
                                                onClick={copyNotes}
                                                className="px-3 sm:px-4 md:px-5 py-2 sm:py-2.5 md:py-3 bg-green-500 text-white border-2 sm:border-4 border-black font-black text-xs sm:text-sm md:text-base uppercase"
                                                style={{ 
                                                    boxShadow: '4px 4px 0px 0px #000',
                                                    transition: 'all 0.1s',
                                                    cursor: 'pointer'
                                                }}
                                                onMouseDown={(e) => {
                                                    e.currentTarget.style.transform = 'translate(2px, 2px)';
                                                    e.currentTarget.style.boxShadow = '2px 2px 0px 0px #000';
                                                }}
                                                onMouseUp={(e) => {
                                                    e.currentTarget.style.transform = 'translate(0px, 0px)';
                                                    e.currentTarget.style.boxShadow = '4px 4px 0px 0px #000';
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.currentTarget.style.transform = 'translate(0px, 0px)';
                                                    e.currentTarget.style.boxShadow = '4px 4px 0px 0px #000';
                                                }}
                                            >
                                                Copy
                                            </button>
                                        </div>
                                        <div className="bg-orange-400 border-2 sm:border-4 border-black p-4 sm:p-5 md:p-6" style={{ boxShadow: '4px 4px 0px 0px #000' }}>
                                            <ul className="space-y-2 sm:space-y-3">
                                                {notes.map((note, idx) => (
                                                    <li key={idx} className="flex items-start text-white">
                                                        <span className="text-black mr-2 sm:mr-3 text-lg sm:text-xl font-black">→</span>
                                                        <span className="text-white font-black leading-relaxed text-sm sm:text-base">{note}</span>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<FinancialHelper />, document.getElementById('root'));
    </script>
</body>
</html>